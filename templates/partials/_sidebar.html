<aside
    class="fixed inset-y-0 left-0 z-50 flex w-72 transform flex-col border-r border-[var(--divider-color)] bg-[var(--bg-medium)] transition-transform duration-300 ease-in-out"
    :class="{ 
        /* Mobile Behavior */
        '-translate-x-full': !isMobileMenuOpen,
        'translate-x-0': isMobileMenuOpen,

        /* Desktop Behavior */
        'lg:translate-x-0': isDesktopSidebarOpen,
        'lg:-translate-x-full': !isDesktopSidebarOpen
    }" x-cloak>

    <div class="flex h-16 shrink-0 items-center justify-between border-b border-[var(--divider-color)] px-4 bg-[var(--bg-medium)]">
        <a href="#" @click.prevent="setView('all'); searchQuery=''" class="flex items-center gap-3 group">
            <i class="material-icons" style="font-size:28px;color:#DD3D2D;">ondemand_video</i>
            <span class="text-lg font-semibold text-[var(--text-bright)] group-hover:text-[var(--text-main)]">VolumePlay21</span>
        </a>
        
        <button type="button"
            class="p-2 text-[var(--text-secondary)] hover:text-[var(--text-bright)] lg:hidden"
            @click="isMobileMenuOpen = false"
            title="Close Menu">
            <i class="material-icons" style="font-size: 24px;">close</i>
        </button>
    </div>

    <nav class="flex-1 space-y-1 overflow-y-auto px-4 pb-4 pt-4">
        <a href="#" @click.prevent="setView('all')"
            class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300"
            :class="currentView.type === 'all' ? 'main-nav-selected' : 'text-[var(--text-main)] hover:bg-[var(--bg-highlight)]/50 hover:text-[#5EEAD4]'"><i
                class="material-icons" style="font-size:20px;">apps</i> All Videos</a>
        <a href="#" @click.prevent="setView('favorites')"
            class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300"
            :class="currentView.type === 'favorites' ? 'main-nav-selected' : 'text-[var(--text-main)] hover:bg-[var(--bg-highlight)]/50 hover:text-[#5EEAD4]'"><i
                class="material-icons" style="font-size:20px;">star_outline</i> Favorites</a>
        <a href="#" @click.prevent="setView('watchLater')"
            class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300"
            :class="currentView.type === 'watchLater' ? 'main-nav-selected' : 'text-[var(--text-main)] hover:bg-[var(--bg-highlight)]/50 hover:text-[#5EEAD4]'"><i
                class="material-icons" style="font-size:20px;">watch_later</i> Watch Later</a>
        <a href="#" @click.prevent="setView('history')"
            class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300"
            :class="currentView.type === 'history' ? 'main-nav-selected' : 'text-[var(--text-main)] hover:bg-[var(--bg-highlight)]/50 hover:text-[#5EEAD4]'"><i
                class="material-icons" style="font-size:20px;">history</i> History</a>

        <hr class="border-[var(--divider-color)] mx-4 my-2">
        
        <div class="pt-2" x-cloak>
            <button @click="sidebarState.filterTags = !sidebarState.filterTags" class="w-full flex items-center justify-between px-3 py-1">
                <h3 class="text-xs font-semibold uppercase text-[var(--text-secondary)]">Browse Folders</h3>
                <i class="material-icons text-[var(--text-secondary)] transition-transform duration-300" :class="{'rotate-180': sidebarState.filterTags}">expand_more</i>
            </button>
            <div x-show="sidebarState.filterTags" x-collapse>
                <div class="mt-1 flex flex-wrap gap-2 px-3 pb-3">
                    <button x-show="filterHistory.length > 0" @click.prevent="goBackOneFilter()"
                        class="inline-flex items-center justify-center h-7 w-7 rounded-full text-[var(--text-main)] hover:text-[var(--text-bright)] hover:bg-[var(--bg-highlight)]/50 transition-colors"
                        title="Go back one step (Filter History)">
                        <span class="material-icons" style="font-size: 20px;">arrow_back</span>
                    </button>
                    <a href="#" @click.prevent="filterByFolderTag('clear_all')"
                        x-show="currentView.type === 'folder' && currentView.id"
                        class="inline-block text-sm font-medium text-[var(--text-main)] hover:text-white px-2 py-0.5 rounded-full cursor-pointer transition-colors duration-150"
                        style="background-color: #6B7280;" title="Clear Folder Filter">
                        Clear All
                    </a>
                    <template x-for="tag in getDynamicTags" :key="tag">
                        <a href="#" @click.prevent="filterByFolderTag(tag)"
                            class="inline-block text-sm font-medium text-[var(--text-highlight)] bg-[#233b4b] hover:bg-[#165357] px-2 py-0.5 rounded-full cursor-pointer transition-colors duration-150"
                            x-text="tag.replace(/_/g, ' ')" :title="'Filter by: ' + tag.replace(/_/g, ' ')">
                        </a>
                    </template>
                    <template x-if="currentView.type !== 'all' && currentView.type !== 'folder'">
                        <p class="text-xs italic text-[var(--text-secondary)]">Tags only available for All Videos/Folders.</p>
                    </template>
                    <template
                        x-if="getDynamicTags.length === 0 && (currentView.type === 'all' || currentView.type === 'folder')">
                        <p class="text-xs italic text-[var(--text-secondary)]">No deeper tags available.</p>
                    </template>
                </div>
            </div>
        </div>

        <hr class="border-[var(--divider-color)] mx-4 my-2">

        <div class="pt-2" x-data="{ newPlaylistName: '' }" x-cloak>
            <button @click="sidebarState.standardPlaylists = !sidebarState.standardPlaylists" class="w-full flex items-center justify-between px-3 py-1">
                <h3 class="text-xs font-semibold uppercase text-[var(--text-secondary)]">Playlists</h3>
                <i class="material-icons text-[var(--text-secondary)] transition-transform duration-300" :class="{'rotate-180': sidebarState.standardPlaylists}">expand_more</i>
            </button>
            <div x-show="sidebarState.standardPlaylists" x-collapse>
                <div class="flex items-center gap-1 px-3 mt-1 mb-2">
                    <input type="text" x-model="newPlaylistName"
                        @keydown.enter="createStandardPlaylist(newPlaylistName); newPlaylistName=''"
                        placeholder="Create new playlist..."
                        class="flex-1 w-full rounded-md border border-[var(--divider-color)] bg-[var(--bg-darkest)] text-sm text-[var(--text-bright)] placeholder-[var(--text-secondary)] focus:border-[var(--highlight-ring)] focus:ring-[var(--highlight-ring)] p-1.5">
                    <button @click="createStandardPlaylist(newPlaylistName); newPlaylistName=''"
                        :disabled="newPlaylistName.trim() === ''"
                        class="p-1 text-[var(--text-secondary)] transition-colors"
                        :class="{ 'hover:text-[var(--text-bright)]': newPlaylistName.trim() !== '', 'opacity-50 cursor-not-allowed': newPlaylistName.trim() === '' }"
                        title="Create New Playlist">
                        <i class="material-icons" style="font-size: 20px;">add</i>
                    </button>
                </div>
                <div class="mt-1 space-y-1">
                    <template x-for="playlist in appData.standardPlaylists" :key="playlist.id">
                        <a href="#" @click.prevent="setView('standard_playlist', playlist.id)"
                            class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-100 hover:bg-[var(--bg-highlight)]/50"
                            :class="currentView.type === 'standard_playlist' && currentView.id === playlist.id ? 'main-nav-selected' : 'text-[var(--text-main)]'">
                            <i class="material-icons" style="font-size:20px;">queue_music</i>
                            <span class="truncate flex-1" x-text="playlist.name"></span>
                        </a>
                    </template>
                    <p x-show="appData.standardPlaylists.length === 0"
                        class="px-3 text-xs italic text-[var(--text-secondary)]">Create a playlist above.</p>
                </div>
            </div>
        </div>

        <hr class="border-[var(--divider-color)] mx-4 my-2">

        <div class="pt-2" x-data="{ newPlaylistName: '' }" x-cloak>
            <button @click="sidebarState.smartPlaylists = !sidebarState.smartPlaylists" class="w-full flex items-center justify-between px-3 py-1">
                <h3 class="text-xs font-semibold uppercase text-[var(--text-secondary)]">Smart Playlists</h3>
                <i class="material-icons text-[var(--text-secondary)] transition-transform duration-300" :class="{'rotate-180': sidebarState.smartPlaylists}">expand_more</i>
            </button>
            <div x-show="sidebarState.smartPlaylists" x-collapse>
                <div class="flex items-center gap-1 px-3 mt-1 mb-2">
                    <input type="text" x-model="newPlaylistName"
                        @keydown.enter="createSmartPlaylist(newPlaylistName); newPlaylistName=''"
                        placeholder="Create smart playlist..."
                        class="flex-1 w-full rounded-md border border-[var(--divider-color)] bg-[var(--bg-darkest)] text-sm text-[var(--text-bright)] placeholder-[var(--text-secondary)] focus:border-[var(--highlight-ring)] focus:ring-[var(--highlight-ring)] p-1.5">
                    <button @click="createSmartPlaylist(newPlaylistName); newPlaylistName=''"
                        :disabled="newPlaylistName.trim() === ''"
                        class="p-1 text-[var(--text-secondary)] transition-colors"
                        :class="{ 'hover:text-[var(--text-bright)]': newPlaylistName.trim() !== '', 'opacity-50 cursor-not-allowed': newPlaylistName.trim() === '' }"
                        title="Create New Smart Playlist">
                        <i class="material-icons" style="font-size: 20px;">add</i>
                    </button>
                </div>
                <div class="mt-1 space-y-1">
                    <template x-for="playlist in appData.smartPlaylists" :key="playlist.id">
                        <div class="relative group">
                            <a href="#" @click.prevent="setView('smart_playlist', playlist.id)"
                                class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-100 hover:bg-[var(--bg-highlight)]/50"
                                :class="currentView.type === 'smart_playlist' && currentView.id === playlist.id ? 'main-nav-selected' : 'text-[var(--text-main)]'">
                                <i class="material-icons" style="font-size:20px;">playlist_play</i>
                                <span class="truncate flex-1" x-text="playlist.name"></span>
                            </a>
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <button @click.stop.prevent="openSmartPlaylistSettings(playlist)"
                                    class="p-0.5 -m-0.5 text-[var(--text-secondary)] hover:text-cyan-400 transition-colors"
                                    title="Smart Playlist Settings">
                                    <i class="material-icons" style="font-size: 18px;">settings</i>
                                </button>
                                <button @click.stop.prevent="renameSmartPlaylist(playlist)"
                                    class="p-0.5 -m-0.5 text-[var(--text-secondary)] hover:text-[var(--text-highlight)] transition-colors"
                                    title="Rename Playlist">
                                    <i class="material-icons" style="font-size: 18px;">edit</i>
                                </button>
                                <button @click.stop.prevent="deleteSmartPlaylist(playlist.id)"
                                    class="p-0.5 -m-0.5 text-red-500 hover:text-red-400 transition-colors"
                                    title="Delete Playlist">
                                    <i class="material-icons" style="font-size: 18px;">delete</i>
                                </button>
                            </div>
                        </div>
                    </template>
                    <p x-show="appData.smartPlaylists.length === 0"
                        class="px-3 text-xs italic text-[var(--text-secondary)]">Create a smart playlist above.</p>
                </div>
            </div>
        </div>

        <hr class="border-[var(--divider-color)] mx-4 my-2">

        <div class="pt-2" x-cloak>
            <button @click="sidebarState.globalFilters = !sidebarState.globalFilters" class="w-full flex items-center justify-between px-3 py-1">
                <h3 class="text-xs font-semibold uppercase text-[var(--text-secondary)]">Global Filters</h3>
                <i class="material-icons text-[var(--text-secondary)] transition-transform duration-300" :class="{'rotate-180': sidebarState.globalFilters}">expand_more</i>
            </button>
            <div x-show="sidebarState.globalFilters" x-collapse class="px-4 pt-2 pb-2 space-y-2">
                <button @click="cycleShortsFilter()"
                    class="flex w-full items-center justify-center gap-2 p-2.5 rounded-md transition-colors text-sm bg-[#29334b] hover:bg-[#43547c] text-[#9CA3AF] hover:text-[#FFFFFF]">
                    <i class="material-icons transition-colors" style="font-size: 20px;" :class="{
                            'text-[var(--text-highlight)]': filterSettings.shorts === 'solo',
                            'text-red-500': filterSettings.shorts === 'hide'
                           }">ondemand_video</i>
                    <span>Shorts</span>
                </button>
                <button @click="cycleVRFilter()"
                    class="flex w-full items-center justify-center gap-2 p-2.5 rounded-md transition-colors text-sm bg-[#29334b] hover:bg-[#43547c] text-[#9CA3AF] hover:text-[#FFFFFF]">
                    <i class="material-icons transition-colors" style="font-size: 20px;" :class="{
                            'text-[var(--text-highlight)]': filterSettings.vr === 'solo',
                            'text-red-500': filterSettings.vr === 'hide'
                           }">view_in_ar</i>
                    <span>3D / VR</span>
                </button>
                <button @click="cycleOptimizedFilter()"
                    class="flex w-full items-center justify-center gap-2 p-2.5 rounded-md transition-colors text-sm bg-[#29334b] hover:bg-[#43547c] text-[#9CA3AF] hover:text-[#FFFFFF]">
                    <i class="material-icons transition-colors" style="font-size: 20px;" :class="{
                            'text-[var(--text-highlight)]': filterSettings.optimized === 'solo',
                            'text-red-500': filterSettings.optimized === 'hide'
                           }">movie_filter</i>
                    <span>Optimized</span>
                </button>

                <div class="border-t border-[var(--divider-color)] my-2"></div>

                <label for="showImages" class="flex items-center justify-between cursor-pointer group">
                    <span class="text-sm text-[var(--text-main)] group-hover:text-white transition-colors">Show Images</span>
                    <input id="showImages" type="checkbox" x-model="filterSettings.showImages" class="rounded bg-[var(--bg-medium)] border-[var(--divider-color)] text-[var(--text-highlight)] focus:ring-[var(--highlight-ring)] cursor-pointer">
                </label>
                
                <div x-show="filterSettings.showImages" x-transition class="pl-2">
                    <label for="showThumbnails" class="flex items-center justify-between cursor-pointer group mt-2">
                        <span class="text-xs text-[var(--text-secondary)] group-hover:text-[var(--text-main)] transition-colors">Include Thumbnails</span>
                        <input id="showThumbnails" type="checkbox" x-model="filterSettings.showThumbnails" class="rounded bg-[var(--bg-medium)] border-[var(--divider-color)] text-[var(--text-highlight)] focus:ring-[var(--highlight-ring)] cursor-pointer">
                    </label>
                </div>

                <div class="border-t border-[var(--divider-color)] my-2"></div>

                <label for="showTitles" class="flex items-center justify-between cursor-pointer">
                    <span class="text-sm text-[var(--text-main)]">Show Titles</span>
                    <input id="showTitles" type="checkbox" x-model="filterSettings.showTitles" class="rounded bg-[var(--bg-medium)] border-[var(--divider-color)] text-[var(--text-highlight)] focus:ring-[var(--highlight-ring)]">
                </label>
                <label for="showFooter" class="flex items-center justify-between cursor-pointer">
                    <span class="text-sm text-[var(--text-main)]">Show Video Footer</span>
                    <input id="showFooter" type="checkbox" x-model="filterSettings.showFooter" class="rounded bg-[var(--bg-medium)] border-[var(--divider-color)] text-[var(--text-highlight)] focus:ring-[var(--highlight-ring)]">
                </label>
                <label for="showDuration" class="flex items-center justify-between cursor-pointer">
                    <span class="text-sm text-[var(--text-main)]">Show Duration</span>
                    <input id="showDuration" type="checkbox" x-model="filterSettings.showDuration" class="rounded bg-[var(--bg-medium)] border-[var(--divider-color)] text-[var(--text-highlight)] focus:ring-[var(--highlight-ring)]">
                </label>
            </div>
        </div>

        <hr class="border-[var(--divider-color)] mx-4 my-2">
        
        <div class="pt-2" x-cloak>
             <button @click="sidebarState.libraryTools = !sidebarState.libraryTools" class="w-full flex items-center justify-between px-3 py-1">
                <h3 class="text-xs font-semibold uppercase text-[var(--text-secondary)]">Library Tools</h3>
                <i class="material-icons text-[var(--text-secondary)] transition-transform duration-300" :class="{'rotate-180': sidebarState.libraryTools}">expand_more</i>
            </button>
            <div x-show="sidebarState.libraryTools" x-collapse class="px-4 pt-2 pb-4 space-y-2">
                <button @click="scanNewVideos()" :disabled="isAnyTaskRunning()"
                    class="w-full flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300 bg-[var(--bg-darkest)] text-[var(--text-highlight)] hover:bg-[var(--divider-color)] disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="material-icons" style="font-size:20px;" :class="{ 'animate-spin': scanType === 'new' }">video_file</i>
                    <span x-text="scanType === 'new' ? 'Scanning New...' : 'Scan New Videos'"></span>
                </button>

                <button @click="generateMissingThumbnails()" :disabled="isAnyTaskRunning()"
                    class="w-full flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300 bg-[var(--bg-darkest)] text-[var(--text-highlight)] hover:bg-[var(--divider-color)] disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="material-icons" style="font-size:20px;" :class="{ 'animate-spin': isGeneratingThumbnails }">image</i>
                    <span x-text="isGeneratingThumbnails ? libraryTaskButtonText : 'Gen. Missing Thumbs'"></span>
                </button>

                <button @click="cleanupLibrary()" :disabled="isAnyTaskRunning()"
                    class="w-full flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300 bg-[var(--bg-darkest)] text-[var(--text-highlight)] hover:bg-[var(--divider-color)] disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="material-icons" style="font-size:20px;" :class="{ 'animate-spin': isCleaningUp }">delete_sweep</i>
                    <span x-text="isCleaningUp ? 'Pruning...' : 'Prune Library'"></span>
                </button>
                
                <button @click="scanFullLibrary()" :disabled="isAnyTaskRunning()"
                    class="w-full flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium transition-colors duration-300 bg-[var(--bg-darkest)] text-[var(--text-highlight)] hover:bg-[var(--divider-color)] disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="material-icons" style="font-size:20px;" :class="{ 'animate-spin': scanType === 'full' }">manage_search</i>
                    <span x-text="scanType === 'full' ? 'Scanning All...' : 'Scan Entire Library'"></span>
                </button>
            </div>
        </div>
    </nav>

    <div class="border-t border-[var(--divider-color)] p-4">
        <a href="https://github.com/volumedata21/volumeplay21" target="_blank" rel="noopener noreferrer"
            class="flex items-center gap-3 text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-bright)] transition-colors">
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" />
            </svg>
        </a>
    </div>
</aside>