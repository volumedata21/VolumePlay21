<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolumePlay</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,line-clamp,typography,aspect-ratio"></script>
    <script src="/static/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="shortcut icon" href="/static/favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon/android-chrome-192x192.png">

    <link rel="stylesheet" href="/static/css/style.css">
    
    <style>
        .yt-icon:hover { color: #FF0000 !important; }
    </style>

</head>
<body
    class="bg-[var(--bg-darkest)] text-[var(--text-main)]"
    x-data="videoApp"
    x-init="init()"
    :class="{ 'overflow-hidden': isMobileMenuOpen || isModalOpen }"
>
    <div x-show="isMobileMenuOpen" @click="isMobileMenuOpen = false" x-transition:enter="transition-opacity ease-in-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-in-out duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 z-30 bg-black/60 lg:hidden" x-cloak></div>

    <div class="flex h-screen">

        <aside
            class="fixed inset-y-0 left-0 z-40 flex w-72 transform flex-col border-r border-[var(--divider-color)] bg-[var(--bg-medium)] transition-transform duration-300 ease-in-out lg:translate-x-0"
            :class="{ '-translate-x-full': !isMobileMenuOpen, 'translate-x-0': isMobileMenuOpen }"
            x-cloak>

            <div class="flex h-16 shrink-0 items-center justify-between border-b border-[var(--divider-color)] px-4">
                <a href="#" @click.prevent="setView('all'); searchQuery=''" class="flex items-center gap-3 group">
                    <i class="material-icons" style="font-size:28px;color:#4A55A2;">ondemand_video</i>
                    <span class="text-lg font-semibold text-[var(--text-bright)] group-hover:text-[var(--text-main)]">VolumePlay</span>
                </a>
                <div class="flex items-center gap-2">
                    <button type="button" class="-mr-2 p-2 text-[var(--text-secondary)] hover:text-[var(--text-bright)] lg:hidden" @click="isMobileMenuOpen = false">
                        <i class="material-icons" style="font-size: 24px;">close</i>
                    </button>
                </div>
            </div>

            <nav class="flex-1 space-y-1 overflow-y-auto px-4 pb-4">
                 <a href="#" @click.prevent="setView('all')" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-[var(--bg-highlight)]/50" :class="currentView.type === 'all' ? 'main-nav-selected' : 'text-[var(--text-main)]'"><i class="material-icons" style="font-size:20px;">apps</i> All Videos</a>
                 <a href="#" @click.prevent="setView('favorites')" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-[var(--bg-highlight)]/50" :class="currentView.type === 'favorites' ? 'main-nav-selected' : 'text-[var(--text-main)]'"><i class="material-icons" style="font-size:20px;">star_outline</i> Favorites</a>
                 <a href="#" @click.prevent="setView('watchLater')" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-[var(--bg-highlight)]/50" :class="currentView.type === 'watchLater' ? 'main-nav-selected' : 'text-[var(--text-main)]'"><i class="material-icons" style="font-size:20px;">watch_later</i> Watch Later</a>
                 <a href="#" @click.prevent="setView('history')" class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-[var(--bg-highlight)]/50" :class="currentView.type === 'history' ? 'main-nav-selected' : 'text-[var(--text-main)]'"><i class="material-icons" style="font-size:20px;">history</i> History</a>
                 
                 <!-- Separator after History -->
                 <hr class="border-[var(--divider-color)] mx-4 my-2">

                <div class="pt-2" x-cloak>
                    <h3 class="px-3 text-xs font-semibold uppercase text-[var(--text-secondary)]">Smart Playlists</h3>
                    <div class="mt-1 space-y-1">
                        <p class="px-3 text-xs italic text-[var(--text-secondary)]">(Coming soon)</p>
                    </div>
                </div>

                 <hr class="border-[var(--divider-color)] mx-4 my-2">

                <!-- Dynamic Filter Tags (With Clear All Option) -->
                <div class="pt-2" x-cloak>
                    <h3 class="px-3 text-xs font-semibold uppercase text-[var(--text-secondary)]">Filter Tags</h3>
                    <div class="mt-1 flex flex-wrap gap-2 px-3 pb-3">
                        
                        <!-- Permanent Clear All Tag -->
                        <a href="#" @click.prevent="filterByFolderTag('clear_all')" 
                           x-show="currentView.type === 'folder' && currentView.id"
                           class="inline-block text-sm font-medium text-[var(--text-main)] hover:text-white px-2 py-0.5 rounded-full cursor-pointer transition-colors duration-150"
                           style="background-color: #6B7280;"
                           title="Clear Folder Filter">
                            Clear All
                        </a>

                        <template x-for="tag in getDynamicTags" :key="tag">
                             <a href="#" @click.prevent="filterByFolderTag(tag)" 
                                class="inline-block text-sm font-medium text-[var(--text-highlight)] hover:text-white hover:underline px-2 py-0.5 rounded-full cursor-pointer transition-colors duration-150"
                                style="background-color: #233b4b;"
                                x-text="tag"
                                :title="'Filter by: ' + tag">
                            </a>
                        </template>
                        <template x-if="currentView.type !== 'all' && currentView.type !== 'folder'">
                            <p class="text-xs italic text-[var(--text-secondary)]">Tags only available for All Videos/Folders.</p>
                        </template>
                        <template x-if="getDynamicTags.length === 0 && (currentView.type === 'all' || currentView.type === 'folder')">
                            <p class="text-xs italic text-[var(--text-secondary)]">No deeper tags available.</p>
                        </template>
                    </div>
                </div>
                
                <!-- The old Folders section is removed per request -->

            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto lg:pl-72">
            <header class="sticky top-0 z-10 flex h-16 shrink-0 items-center justify-between border-b border-[var(--divider-color)] bg-[var(--bg-darkest)]/80 px-4 backdrop-blur-sm sm:px-6 lg:px-8">
                 <button type="button" class="-ml-2.5 p-2.5 text-[var(--text-secondary)] hover:text-[var(--text-bright)] lg:hidden" @click="isMobileMenuOpen = true">
                     <i class="material-icons" style="font-size: 24px;">menu</i>
                 </button>
                 <div class="hidden min-w-0 flex-1 items-center gap-2 lg:flex">
                     <button x-show="currentView.type === 'author' || currentView.type === 'folder' || currentView.type === 'custom_stream' || currentView.type === 'category'" @click="setView('all'); searchQuery=''" class="p-1 text-[var(--text-secondary)] hover:text-[var(--text-bright)] rounded-full hover:bg-[var(--bg-medium)]" title="Clear filter" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95" x-cloak>
                         <span class="material-icons" style="font-size: 20px;">close</span>
                     </button>
                     <div class="min-w-0 flex-1">
                         <h1 class="truncate text-xl font-semibold text-[var(--text-bright)]" x-text="currentTitle"></h1>
                     </div>
                 </div>
                 <div class="flex shrink-0 items-center gap-2 pl-4">
                     <div class="relative">
                         <span class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                             <i class="material-icons text-[var(--text-secondary)]" style="font-size: 20px;">search</i>
                         </span>
                         <input type="search" placeholder="Search..." x-model.debounce.300ms="searchQuery" class="w-40 rounded-md border-[var(--divider-color)] bg-[var(--bg-medium)] pl-10 text-sm text-[var(--text-bright)] placeholder-[var(--text-secondary)] focus:border-[var(--highlight-ring)] focus:ring-[var(--highlight-ring)] sm:w-52">
                     </div>
                     <select x-model="sortOrder" class="hidden rounded-md border-[var(--divider-color)] bg-[var(--bg-medium)] text-sm text-[var(--text-bright)] focus:border-[var(--highlight-ring)] focus:ring-[var(--highlight-ring)] sm:block">
                         <option value="newest">Newest First</option>
                         <option value="oldest">Oldest First</option>
                     </select>
                     <button class="p-2 text-[var(--text-secondary)] hover:text-[var(--text-bright)]" @click="scanVideoLibrary(false)" :disabled="isScanning">
                         <i class="material-icons" :class="{ 'animate-spin': isScanning }" style="font-size: 20px;">refresh</i>
                     </button>
                 </div>
             </header>

            <div class="grid grid-cols-1 gap-6 p-4 sm:grid-cols-2 lg:grid-cols-3" x-cloak>
                 <template x-if="filteredVideos.length === 0">
                     <p class="text-[var(--text-secondary)]" x-text="getEmptyMessage()"></p>
                 </template>
                 <template x-for="video in filteredVideos" :key="video.id">
                     <div class="flex flex-col overflow-hidden rounded-lg bg-[var(--bg-medium)] shadow-lg">
                         <a href="#" @click.prevent="openModal(video)">
                             <template x-if="video.image_url">
                                 <img class="w-full object-cover aspect-video" :src="video.image_url" alt="" @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'">
                                 <div class="hidden w-full items-center justify-center bg-[var(--bg-darkest)] text-[var(--text-secondary)] aspect-video">(Image failed)</div>
                             </template>
                             <template x-if="!video.image_url">
                                 <div class="flex w-full items-center justify-center bg-[var(--bg-darkest)] text-[var(--text-secondary)] aspect-video">(No Thumbnail)</div>
                             </template>
                         </a>
                         <div class="flex flex-1 flex-col justify-between p-5">
                             <div class="flex-1">
                                 <h3 class="text-md font-semibold text-[var(--text-bright)] leading-tight" style="text-wrap: balance;">
                                     <a href="#" @click.prevent="openModal(video)" class="hover:underline" x-text="video.title"></a>
                                 </h3>
                             </div>
                         </div>
                         <div class="flex items-center justify-between gap-2 border-t border-[var(--divider-color)] p-3 px-5">
                             <!-- Show Title Capsule in Main Feed -->
                             <div class="min-w-0 flex-1 text-sm text-[var(--text-secondary)]">
                                 <a href="#" @click.prevent="setView('author', null, video.author)" 
                                    class="inline-block font-medium text-[var(--text-highlight)] hover:underline px-2 py-0.5 rounded-full"
                                    style="background-color: #233b4b;"
                                    x-text="video.author"></a>
                                 <span class="block truncate text-xs mt-1" x-text="formatDateAgo(video.published, video.uploaded)"></span>
                             </div>
                             <div class="flex shrink-0 items-center gap-2">
                                <button class="p-1" @click.prevent="toggleFavorite(video)" :class="video.is_favorite ? 'text-[var(--text-highlight)]' : 'text-[var(--text-secondary)] hover:text-[var(--text-highlight)]'"><i class="material-icons" style="font-size: 20px;" x-text="video.is_favorite ? 'star' : 'star_border'"></i></button>
                                <button class="p-1" @click.prevent="toggleBookmark(video)" :class="video.is_read_later ? 'text-[var(--text-highlight)]' : 'text-[var(--text-secondary)] hover:text-[var(--text-highlight)]'"><i class="material-icons" style="font-size: 20px;" x-text="video.is_read_later ? 'watch_later' : 'schedule'"></i></button>
                             </div>
                         </div>
                     </div>
                 </template>
            </div>

            <div class="pb-8 text-center" x-show="fullFilteredList.length > videosToShow" x-cloak>
                 <p class="mb-2 text-xs text-[var(--text-secondary)]">
                     Showing <span x-text="filteredVideos.length"></span> of <span x-text="fullFilteredList.length"></span> videos
                 </p>
                 <button @click="loadMoreVideos()"
                         class="rounded-md bg-[var(--bg-highlight)] px-5 py-2.5 text-sm font-medium text-[var(--text-bright)] hover:bg-[var(--bg-highlight-hover)] focus:outline-none focus:ring-2 focus:ring-[var(--highlight-ring)] focus:ring-opacity-50">
                     Load More (75)
                 </button>
            </div>
        </main>
    </div>

    <div x-show="isModalOpen" @keydown.escape.window="closeModal()" class="fixed inset-0 z-50 flex items-start justify-center overflow-y-auto bg-black/80 p-4 pt-12 sm:p-8" x-cloak>
        <div class="fixed inset-0" @click="closeModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"></div>
        
        <div class="relative z-10 w-full max-w-5xl overflow-hidden rounded-lg bg-[var(--bg-medium)] shadow-xl" 
             x-show="isModalOpen" 
             x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" 
             x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
             
            <template x-if="modalVideo">
                 <div>
                     
                     <!-- 1. VIDEO PLAYER (TOP) -->
                     <div class="p-0 bg-black">
                         <video x-if="modalVideo"
                                class="w-full max-h-[80vh] h-auto"
                                :src="modalVideo.video_url"
                                controls
                                autoplay
                                @ended="closeModal()"
                                x-ref="videoPlayer" 
                                >
                             Your browser does not support the video tag.
                         </video>
                     </div>

                     <!-- 2. METADATA BLOCK (TITLE, AUTHOR, DATE, ICONS, AND DESCRIPTION) -->
                     <div class="p-4 sm:p-5">
                         
                         <!-- Title -->
                         <h2 class="text-xl font-semibold text-[var(--text-bright)]" x-text="modalVideo.title"></h2>
                         
                         <!-- Author/Show Title (The clickable filter in a capsule) -->
                         <div class="mt-1 text-sm inline-block">
                             <a href="#" @click.prevent="closeModal(); setView('author', null, modalVideo.author)" 
                                class="font-medium text-[var(--text-highlight)] hover:underline px-2 py-0.5 rounded-full"
                                style="background-color: #233b4b;"
                                x-text="modalVideo.author || 'Unknown Author'">
                             </a>
                         </div>
                         
                         <!-- Air Date (Formatted to "Time Ago") -->
                         <div class="mt-0.5 text-xs text-[var(--text-secondary)]" 
                              x-text="formatDateAgo(modalVideo.published, modalVideo.uploaded)">
                         </div>

                         <!-- Icons/Actions -->
                         <div class="mt-4 flex items-center gap-4 border-b border-[var(--divider-color)] pb-3">
                             
                             <!-- Favorites Button -->
                             <button class="flex items-center gap-1.5 p-1.5 text-sm" 
                                     @click.prevent="toggleFavorite(modalVideo)" 
                                     :class="modalVideo.is_favorite ? 'text-[var(--text-highlight)]' : 'text-[var(--text-secondary)] hover:text-[var(--text-highlight)]'">
                                 <i class="material-icons" style="font-size: 20px;" x-text="modalVideo.is_favorite ? 'star' : 'star_border'"></i>
                                 <span class="hidden sm:inline" x-text="modalVideo.is_favorite ? 'Favorite' : 'Add to Favorites'"></span>
                             </button>
                             
                             <!-- Watch Later Button -->
                             <button class="flex items-center gap-1.5 p-1.5 text-sm" 
                                     @click.prevent="toggleBookmark(modalVideo)" 
                                     :class="modalVideo.is_read_later ? 'text-[var(--text-highlight)]' : 'text-[var(--text-secondary)] hover:text-[var(--text-highlight)]'">
                                 <i class="material-icons" style="font-size: 20px;" x-text="modalVideo.is_read_later ? 'watch_later' : 'schedule'"></i>
                                 <span class="hidden sm:inline" x-text="modalVideo.is_read_later ? 'Bookmarked' : 'Watch Later'"></span>
                             </button>
                             
                             <!-- Watch on YouTube Link -->
                             <template x-if="modalVideo.youtube_id">
                                 <a :href="'https://www.youtube.com/watch?v=' + modalVideo.youtube_id" 
                                    target="_blank" 
                                    class="flex items-center gap-1.5 p-1.5 text-sm text-[var(--text-secondary)] yt-icon"
                                    title="Watch on YouTube">
                                    <i class="material-icons" style="font-size: 20px;">smart_display</i>
                                    <span class="hidden sm:inline">YouTube</span>
                                 </a>
                             </template>
                             
                             <!-- Close Button -->
                             <button class="ml-auto h-8 w-8 flex-shrink-0 rounded-full bg-[var(--bg-darkest)] flex items-center justify-center text-[var(--text-secondary)] hover:bg-[var(--bg-highlight)] hover:text-[var(--text-bright)]" 
                                     @click="closeModal()" 
                                     title="Close Player">
                                 <i class="material-icons" style="font-size: 20px;">cancel</i>
                             </button>
                         </div>
                         
                         <!-- 3. DESCRIPTION/SUMMARY (WITH SCROLLING) -->
                         <div class="mt-3 max-h-[25vh] overflow-y-auto">
                             <div class="prose prose-sm prose-invert max-w-none text-[var(--text-main)]" 
                                  style="overflow-wrap: break-word;" 
                                  x-html="formatVideoDescription(modalVideo.summary || 'No summary available.')">
                             </div>
                         </div>
                     </div>
                 </div>
             </template>
        </div>
    </div>

</body>
</html>
